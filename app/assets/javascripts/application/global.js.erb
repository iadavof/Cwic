var current_user, current_organisation, current_locale;

// Temporary disable Turbolinks page cache functionality to solve back-button related problems.
// TODO: implement real solution for this and other Turbolinks problems and re-enable page cache.
Turbolinks.pagesCached(0);

APP.init = function() {
  // Load current_user and current_organisation data
  var body = $('body');
  current_user = { id: parseInt(body.data('current-user-id')), name: body.data('current-user-name') };
  current_organisation = { id: parseInt(body.data('current-organisation-id')) };
  current_locale = body.data('current-locale');
  this.global.initLocale(current_locale);

  if ($('#header:visible').length > 0) {
    // Load the menu
    this.global.menuInit();
    this.global.keyboardShortcutsInit();
    this.global.searchBarInit();

    // Load the feedback module
    new CwicFeedback({
      open_button_id: 'open-feedback-button',
      backend_url: Routes.feedbacks_path({ format: 'json' })
    });
  }

  // Load the api for the local menu
  this.global.loadLocalMenu();

  // Load Google if needed
  $(document).on('page:load', APP.global.initializeGoogleMapsFunctions);

  // Replace default confirm box with our confirm
  this.global.replaceConfirmBox();

  // Load stickies (if #note-container is present)
  this.stickies.loadStickies();

  // Set the upper nprogress bar as the default ajax complete and start handlers
  this.global.addProgressbarToAjax();

  // Initialize tabs
  this.global.initializeTabs();

  // Initialize special form fields, such as date- and timepickers, special Cwic Controls (select, checkbox, ...)
  this.global.initializeSpecialFormFields();

  // Make select all button on tables work
  this.global.bindSelectAllCheckboxEvents();

  // Add select2 in tagging mode to taggling list text field
  this.global.loadTaggingSelect2Box();

  // Initialize Images containers
  $('div.images-container').magnificPopup({ delegate: 'a', type: 'image',  gallery: { enabled: true } });

  // Auto submit limiting fields
  $('#limiting select').on('change', function() { this.form.submit(); });

  // Replace AJAX spinner with svg version if SMIL animations are available
  if(Modernizr.backgroundsize && Modernizr.smil) {
    $('img.ajax-wait').attr('src', '<%= asset_path('ajax_wait.svg') %>');
    $('.ajax-wait:not(img)').css('background-image', 'url("<%= asset_path('ajax_wait.svg') %>") !important');
  }

  this.global.bindHelpModalEvents();

  this.global.contentAreaResize();
  $(window).on('resize', function() {
    APP.global.contentAreaResize();
  });

  $(document).keydown(function(event) {
    /* Close search bar when esc button is pressed */
    if(event.keyCode == 27) {
      APP.global.slideSearchBar('collapse');
    }
  });
};

// Add progress bar for Turbolink requests
$(document).on('page:fetch', function() { NProgress.stackPush(); });
$(document).on('page:load', function() { NProgress.stackPop(); });
$(document).on('page:restore', function() { NProgress.remove(); });

APP.global = {
  initLocale: function(locale) {
    $.datepicker.setDefaults($.datepicker.regional[locale]);
    $.timepicker.setDefaults($.timepicker.regional[locale]);
    jsLang = jsLangs[locale]; // TODO this is not very nice. Better to rewrite whole custom application JavaScript translations to I18n-js gem (if it is stable, ask Kevin for more information)
  },
  bindHelpModalEvents: function() {
    $('.help i').on('click', function() {
      var content = $('<p/>');
      content.text($(this).attr('title'));
      APP.modal.openModal('help-modal', content);
    });
  },
  bindSelectAllCheckboxEvents: function() {
    $('input.select-all-checkbox').siblings('div.cwic-checkbox').on('click', function() {
      var select_all_button = $(this).siblings('input.select-all-checkbox');
      select_all_button.parents('table').find('input.select-all-child').prop('checked', select_all_button.is(':checked')).trigger('change');
    });

    $('input.select-all-child').on('change', function() {
      var select_all_child = $(this);
      var select_all_childs = select_all_child.parents('table').find('input.select-all-child');
      var select_all_button = select_all_child.parents('table').find('input.select-all-checkbox');

      var all_selected = true;
      select_all_childs.each(function() {
        if(!$(this).is(':checked')) {
          all_selected = false;
          // We dont need to continue the each loop
          return false;
        }
      });

      select_all_button.prop('checked', all_selected).trigger('change');

    });
  },
  contentAreaResize: function(location) {
    if(Modernizr.flexbox) {
      return;
    }
    $('#page-wrapper').css({top: $('#search-bar').is('.open') ? $('#header').outerHeight() + 'px' : $('#header').outerHeight() - $('#search-bar').outerHeight() + 'px'});
    if (!Modernizr.csstransforms) {
      $('#header').css({top: -$('#header').outerHeight() + 'px'});
    }
    $('#content-area').css({top: $('#local-menu').outerHeight() + 'px'});
  },
  menuInit: function() {
    var $submenuBox = $('#submenu-box');
    var $menuItems = $('#main-menu > li');

    this.slideSubMenuByMenuItem($('#main-menu > li.active').first().attr('id'), false);

    $('#main-menu > li > a').on('click', function() {
      return APP.global.slideSubMenuByMenuItem($(this).parent('li').attr('id'), true);
    });

    /* Highlight shortcut letters */
    $menuItems.children('a').each(function(){
      var shortcutKey = APP.global.getShortcutKeyById($(this).data('shortcutFor'));
      if (shortcutKey) {
        var txt = $(this).text();
        var index = txt.toUpperCase().indexOf(shortcutKey);
        if (index >= 0) {
          $(this).html(txt.substring(0, index) + '<span class="shortcut-highlight">' + txt.substring(index, index + 1) + '</span>' + txt.substring(index + 1)).attr('title', jsLang.global.expand_menu + ' [Alt+' + shortcutKey + ']');
        }
      }
    });
  },
  loadLocalMenu: function(){
    window.localMenu = new CwicLocalMenu($('div#local-menu'));
  },
  searchBarInit: function() {
    var $searchBar = $('#search-bar');
    $('#open-search-button').on('click', function() {
      $(window).trigger('header-start-animation');
      if(!$searchBar.hasClass('open')) {
        APP.global.slideSearchBar('expand');
      } else {
        APP.global.slideSearchBar('collapse');
      }
      return false;
    });
  },
  slideSearchBar: function(action) {
    var $searchField = $('#global_search_query');

    var complete = function() {
      $(window).trigger('header-animated');
      if (action == 'expand') {
        $searchField.focus();
      }
    };

    if (action == 'collapse') {
      $searchField.blur().val('');
      $('#open-search-button').removeClass('open');
    } else {
      $('#open-search-button').addClass('open');
    }

    if (Modernizr.flexbox) {
      APP.util.expandCollapse('#search-bar', {action: action, direction: 'vertical', duration: 150, targetDimension: 'auto'}, complete);
    } else {
      var $pageWrapper = $('#page-wrapper');
      var $searchBar = $('#search-bar');
      $pageWrapper.velocity({top: (action == 'expand' ? $('#header').outerHeight() : $('#menu-bar').outerHeight()) + 'px'}, 150, 'swing', function() {
        if (action == 'expand') {
          $searchBar.addClass('open');
        } else {
          $searchBar.removeClass('open');
        }
        complete();
      });
    }
  },
  addProgressbarToAjax: function() {
    NProgress.configure({ container: $('#progress-bar-container'), showSpinner: false });

    $(document).ajaxStart(function() {
      NProgress.stackPush();
    });

    $(document).ajaxComplete(function() {
      NProgress.stackPop();
    });
  },
  slideSubMenuByMenuItem: function(htmlId, animated) {
    var $menuItem = $('#' + htmlId);
    var $relatedSubmenu = $('#submenu-box > .submenu[data-main-menu-relation="' + htmlId + '"]').first();

    if (!htmlId || $relatedSubmenu.length == 0 || $menuItem.length == 0) {
      return true;
    } else {
      var $submenuBox = $('#submenu-box');
      var $menuItems = $('#main-menu > li');

      if ($menuItem.hasClass('selected')) {
        /* Contract submenu if clicked menu item is the selected one */
        APP.global.slideSubMenu($relatedSubmenu, 'collapse', animated, function() {
          $menuItems.removeClass('selected');
        });
      } else {
        if ($submenuBox.hasClass('open')) {
          /* Contract expanded submenu first, then expand requested submenu */
          APP.global.slideSubMenu($relatedSubmenu, 'switch', animated, function() {
            $menuItems.removeClass('selected'); $menuItem.addClass('selected');
          });
        } else {
          /* Expand requested submenu */
          APP.global.slideSubMenu($relatedSubmenu, 'expand', animated, function() {
            $menuItems.removeClass('selected'); $menuItem.addClass('selected');
          });
        }
      }
      return false;
    }
  },
  slideSubMenu: function(submenu, action, animated, executeBefore, executeAfter) {
    var $submenu = $(submenu);
    var executeBefore = executeBefore ? executeBefore : function() {};
    var executeAfter = executeAfter ? executeAfter : function() {};
    var duration = animated ? 200 : 0;

    switch (action) {
      case 'expand':
      case 'collapse':
        var $submenuBox = $('#submenu-box');

        executeBefore();

        var complete = executeAfter;
        if (action == 'expand') {
          APP.global.slideSubMenu($submenu, 'switch', false);
        } else {
          var $submenus = $submenuBox.find('> .submenu');
          complete = function() {
            $submenus.removeClass('selected');
            $submenuBox.removeClass('open');
            executeAfter();
          };
        }

        if (Modernizr.flexbox) {
          APP.util.expandCollapse($submenuBox, {action: action, direction: 'horizontal', duration: duration, targetDimension: ''}, complete);
        } else {
          var $mainArea = $('#main-area');
          if (animated) {
            $submenuBox.addClass('open');
            $mainArea.velocity({left: action == 'expand' ? $submenuBox.outerWidth() + 'px' : 0}, duration, 'swing', complete);
          } else {
            $submenuBox.addClass('open');
            $mainArea.css({left: action == 'expand' ? $submenuBox.outerWidth() + 'px' : 0});
            executeAfter();
          }
        }
        break;
      case 'switch':
        executeBefore();
        var $submenus = $('#submenu-box > .submenu');
        if (animated) {
          $submenus.velocity({opacity: 0}, duration/2.5, 'swing', function() {
            $submenus.removeClass('selected');
            $submenu.velocity({opacity: 1}, duration/2.5, 'swing', function() {
              $submenu.addClass('selected');
              executeAfter();
            });
          });
        } else {
          $submenus.css({opacity: 0}).removeClass('selected');
          $submenu.css({opacity: 1}).addClass('selected');
          executeAfter();
        }
        break;
    }
  },
  replaceConfirmBox: function() {
    $.rails.allowAction = function(element) {
      if(element.data('skip-confirm-once')) { element.data('skip-confirm-once', null); return true; }

      var message = element.data('confirm');
      if(!message) { return true; }

      if($.rails.fire(element, 'confirm')) {
        APP.global.createConfirmBox(element, message);
      }
      return false;
    };
    $.rails.allowActionAnswer = function(element, answer) {
      callback = $.rails.fire(element, 'confirm:complete', [answer]);
      if(answer && callback) {
        element.data('skip-confirm-once', true); // Skip the confirm question once
        element.trigger('click'); // Replay the action. Note this works for certain elements (links, buttons, etc.), but probably not all kinds.
      }
    };
  },
  createConfirmBox: function(element, message) {
    var content = $('<div>');

    content.append($('<p>', { text: message, class: 'confirm-question' }));

    var notOkButton = $('<a>', { class: 'button red', text: jsLang.global.no });
    var okButton = $('<a>', { class: 'button green', text: jsLang.global.yes });

    var okAction = function() { APP.modal.closeModal(); $.rails.allowActionAnswer(element, true); };

    notOkButton.on('click', function() { APP.modal.closeModal(); $.rails.allowActionAnswer(element, false); });
    okButton.on('click', okAction);

    $(document).on('keyup.enter', function(e) {
      e.preventDefault();
      if (e.keyCode == 13) { okAction(); }
    });

    content.append(notOkButton);
    content.append(okButton);

    APP.modal.openModal('confirm', content);
  },
  keyboardShortcutsInit: function() {
    $(document).keydown(function(event) {
      if(event.altKey) {
        var keyString = String.fromCharCode(event.which);
        $('#main-menu > li > a').each(function(){
          var menuItemId = $(this).parent().attr('id');
          var menuItemShortcutKey = APP.global.getShortcutKeyById($(this).data('shortcutFor'));
          if(keyString == menuItemShortcutKey) {
            return APP.global.executeShortcut(menuItemId);
          }
        });
      }
    });
  },
  executeShortcut: function(htmlId) {
    this.slideSubMenuByMenuItem(htmlId, true);
    return false;
  },
  getShortcutKeyById: function(id) {
    var key = jsLang.shortcutKeys[id.replace(/[^a-zA-Z0-9]/g, '_')];
    if (typeof(key) != 'undefined' && key.length == 1) {
      return key.toUpperCase();
    } else {
      return false;
    }
  },
  initializeTabs: function() {
    var container = $('#tabs');
    container.tabs({ active: this.determineFirstTabWithErrors(container) });
  },
  determineFirstTabWithErrors: function(container) {
    // Determines the first tab to open. This is the first tab with errors (if any, else simply open the first tab). Also adds the 'with-errors' class to any tabs with errors.
    var first = 0;
    var determined = false;
    container.find('.nav a').each(function(index) {
      var id = $(this).attr('href'); // Starts with #
      var tab = container.find(id);
      if(tab.find('.validation-error').length) {
        if(first == 0 && !determined) {
          first = index;
          determined = true;
        }
        $(this).addClass('with-errors');
      }
    });
    return first;
  },
  initializeSpecialFormFields: function(parent) {
    if(!parent) {
      parent = document.body;
    }
    $(parent).find(':radio, :checkbox, input[type=file]').cwicControl();
    $(parent).find('select').select2({
      width: 'resolve',
      minimumResultsForSearch: -1,
    });
    $(parent).find('.datepicker-field').datepicker();
    $(parent).find('.timepicker-field').timepicker({ showPeriodLabels: false });
    $(parent).find('input.organisation_client_select').each(this.initializeOrganisationClientSelect);
    $(parent).find('input.with-clear').each(this.initializeInputWithClear);

    $(document).on('nested:fieldAdded', function(e) { APP.global.initializeSpecialFormFields(e.field); });

    $(parent).find('.select2-offscreen.autosubmit').on('change', function() {
      $(this).prev('.select2-container').addClass('autosubmit-busy');
    });
  },
  initializeInputWithClear: function() {
    var input = $(this);
    if(input.val() != '') {
      input.wrap('<div class="field-with-clear"></div>');
      var span = $('<span>', { text: 'X' });
      input.after(span);
      span.on('click', function() {
        input.val(null);
        $(this).remove();
        input.unwrap();
        input.trigger('change');
      });
    }
  },
  initializeOrganisationClientSelect: function() {
    $(this).select2({
      initSelection: function(element, callback) {
          var id = $(element).val();
          var text = $(element).data('prev-selected') || jsLang.reservations.select_client_placeholder;
          return callback({id: id, text: text });
      },
      placeholder: jsLang.reservations.select_client_placeholder,
      minimumInputLength: 1,
      width: 'resolve',
      ajax: {
        url: Routes.autocomplete_organisation_organisation_clients_path(current_organisation, { format: 'json' }),
        dataType: 'json',
        quietMillis: 500,
        data: function(term, page) {
          return { q: term, page: page };
        },
        results: function(data, page) {
          return data;
        }
      },
    });
  }, // The following function will be used as a callback for loading the google maps libs and will be called after the libs is loaded
  initializeGoogleMapsFunctions: function() {
    if (typeof google === 'object' && typeof google.maps === 'object') {
      if(typeof APP[$('body').data('controller')] === 'object' && typeof APP[$('body').data('controller')].afterGoogleMapsLoaded == 'function') {
        APP[$('body').data('controller')].afterGoogleMapsLoaded();
      }
    }
  },
  loadTaggingSelect2Box: function() {
    $('.tags-field').each(function() {
      var tagField = $(this);
      var saved = tagField.data('saved').map(function(item) { return { id: item, name: item } });
      tagField.select2({
        tags: true,
        placeholder: jsLang.global.add_tags,
        minimumInputLength: 1,
        initSelection : function(element, callback) {
          saved && callback(saved);
        },
        tokenSeparators: [','],
        multiple: true,
        ajax: {
          type: 'POST',
          url: Routes.tag_search_organisation_path(current_organisation),
          dataType: 'json',
          quietMillis: 200,
          data:    function(term) { return { tag_part: term }; },
          results: function(data) { return { results: data.map(function(item) { return { id: item.name, name: item.name } }) }; }
        },
        createSearchChoice: function(term, data) {
          var filterFunction = function() {
            return this.name.localeCompare(term) === 0;
          };

          if($(data).filter(filterFunction).length === 0) {
            return { id: term.toLowerCase(), name: term.toLowerCase() };
          }
        },
        formatResult:    function(item, page){ return APP.util.ucFirst(item.name); },
        formatSelection: function(item, page){ return APP.util.ucFirst(item.name); }
      });
    });
  }
};
